---
title: "Basic workflow using rocc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{check}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
library(knitr)
```

## 0. Installing and loading package

```{r eval = FALSE}
remotes::install_github("saramortara/rocc")
library(rocc)
```

## 1. Taxonomy check of the preliminary species list

Here, we have a short list of two fern species. 

```{r spp}
species <- c("Asplenium truncorum", "Lindsaea lancea")
```

We'll start by checking species taxonomy and searching for synonyms.

```{r check-taxon}
species_check <- lapply(species, check_flora)
```

#### *Asplenium truncorum*

```{r asplenium}
# para A. truncorum
species_check[[1]]$taxon
species_check[[1]]$synonyms
```

This is a valid name with no synonyms.

#### *Lindsaea lancea*

```{r lindsaea}
# L. lancea
species_check[[2]]$taxon
species_check[[2]]$synonyms
```

This is a valid name and `r species_check[[2]]$synonym_species` is a synonym. The synonym will also be included in the search in order to get the complete distribution of the species.

## 2. Download and bind data from different sources

Here, we are downloading data from two species of ferns and its synonyms.

```{r syn-search}
synonyms <- unlist(sapply(species_check, function(x) x$synonyms$synonym_species))
species_search <- c(species, synonyms)
```


### Species Link

```{r rspecieslink}
data_splink <- list()
for (sp in species_search) {
  data_splink[[sp]] <- rspeciesLink(species = sp, 
                              filename = paste0(gsub(" ", "_", sp), "_splink"))
}

df_splink <- bind_rows(data_splink, .id = "species_id") 
```

### GBIF

```{r gbif}
data_gbif <- list()

for (sp in species_search) {
  data_gbif[[sp]] <- rgbif2(species = sp, 
                      filename = paste0(gsub(" ", "_", sp), "_gbif"))
}

df_gbif <- bind_rows(data_gbif, .id = "species_id")
```


## 3. Binding data from different sources

```{r bind_data}
df <- bind_dwc(splink_data = df_splink, gbif_data = df_gbif)
```

## 3. Check string in species name

Given that the data base might come from source with errors, we perform a basic check on the string of a species name. We will select only unique entries in species names.

```{r species-raw}
# Vector of unique entries in species names
species_name_raw <- unique(df$scientificName)
```

For the unique entries, we will perform a basic check on the string.

```{r check-string}
species_name_check  <- check_string(species_name_raw)
species_name_check
```

Here, we are interested only in the names assigned with `possibly_ok` and `name_w_authors`. Now we will filter the occurrence data within these categories. 

```{r species-ok}
verbatimSpecies_ok <- species_name_check$verbatimSpecies[species_name_check$speciesStatus %in% c("possibly_ok", "name_w_authors")]
df_ok <- df[df$scientificName %in% verbatimSpecies_ok, ]

```

In this cleaning we went from a total of `r nrow(df)` occurrences to `r 1505` occurrences. 

Finally, we can write the resultant occurrence data on disk. 

```{r write}
write.csv(df_ok, "results/occurrence_data.csv", row.names = FALSE)
```

